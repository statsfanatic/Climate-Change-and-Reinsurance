library(fpp2)
library(tseries)
library(stats)
library(ggplot2)

WeatherData <- read.csv("~/Desktop/HAIIvVE/06_Predict Toronto Weather Project/Toronto_temp.csv")
# exploring the structure of the original dataset
str(WeatherData)

# selecting data for the first day each month
Monthly <- subset(WeatherData,Day==1)

# selecting specific (seasonal) months
Seasonal <- subset(Monthly, Month==1 | Month==4 | Month==7 | Month==10, select=Date.Time:Mean.Temp..C.)
# exploring the aspect of the seasonal data
autoplot(ts(Seasonal$Mean.Temp..C.))
head(Seasonal)

# data treatment: cleaning commas and ordering by year/month
Seasonal$Year = as.numeric(gsub(",","", Seasonal$Year))
Seasonal <- Seasonal[order(Seasonal$Year,Seasonal$Month),]
# selecting a subset to analyse behavior on a small scale
Seasonal_small <- Seasonal[1:50,]
plot(Seasonal_small$Mean.Temp..C.)
lines(Seasonal_small$Mean.Temp..C.)
# erasing rows with missing values: only 1 data point
Seasonal <- subset(Seasonal, Mean.Temp..C.<100)
# we have a time series. Now let's build a vector of years with fractional values
x <- seq(1938,2018.5,0.25)
Seasonal$x <- x
# so we can plot the data relative to the year of the observation
plot(Seasonal$x,Seasonal$Mean.Temp..C.)
lines(Seasonal$x,Seasonal$Mean.Temp..C.)

# hold-out
test <- Seasonal[(1+ceiling(nrow(Seasonal)*0.8)):nrow(Seasonal),]
train <- Seasonal[1:ceiling(nrow(Seasonal)*0.8),]

# Support Vector Regression, regressed Mean.Temp..C on year + month
require (e1071)
modelSVR <- svm(Mean.Temp..C. ~ Year + Month , train)
predictedSVR <- predict(modelSVR, test)
tuneResult <- tune(svm, Mean.Temp..C. ~ Year + Month,  data = train, ranges = list(epsilon = seq(0,1,0.1), cost = 2^(2:9)))
tunedModel <- tuneResult$best.model
tunedModel
predictedSVRtuned <- predict(tunedModel, test)
# evaluating the predictions
sqrt(mean((test$Mean.Temp..C. - unname(predictedSVRtuned))^2))
sqrt(mean((train$Mean.Temp..C. - unname(predict(tunedModel, train)))^2))
# do plots
autoplot(ts(predictedSVRtuned)) + autolayer(ts(test$Mean.Temp..C.))

# Residual ACF
autoplot(ts(test$Mean.Temp..C. - unname(predictedSVR)))

# Forecasting and Conclusion
cast <- subset(test, select=Year:Month)
cast[nrow(cast) + 1,] = c(2019,1)
cast[nrow(cast) + 1,] = c(2019,4)
cast[nrow(cast) + 1,] = c(2019,7)
cast[nrow(cast) + 1,] = c(2019,10)
cast[nrow(cast) + 1,] = c(2020,1)
cast[nrow(cast) + 1,] = c(2020,4)
cast[nrow(cast) + 1,] = c(2020,7)
cast[nrow(cast) + 1,] = c(2020,10)
cast[nrow(cast) + 1,] = c(2021,1)
cast[nrow(cast) + 1,] = c(2021,4)
cast[nrow(cast) + 1,] = c(2021,7)
cast[nrow(cast) + 1,] = c(2021,10)
cast[nrow(cast) + 1,] = c(2022,1)
cast[nrow(cast) + 1,] = c(2022,4)
cast[nrow(cast) + 1,] = c(2022,7)
cast[nrow(cast) + 1,] = c(2022,10)
cast[nrow(cast) + 1,] = c(2023,1)
cast[nrow(cast) + 1,] = c(2023,4)
cast[nrow(cast) + 1,] = c(2023,7)
cast[nrow(cast) + 1,] = c(2023,10)
cast[nrow(cast) + 1,] = c(2024,1)
cast[nrow(cast) + 1,] = c(2024,4)
cast[nrow(cast) + 1,] = c(2024,7)
cast[nrow(cast) + 1,] = c(2024,10)
cast[nrow(cast) + 1,] = c(2025,1)
cast[nrow(cast) + 1,] = c(2025,4)
cast[nrow(cast) + 1,] = c(2025,7)
cast[nrow(cast) + 1,] = c(2025,10)
cast[nrow(cast) + 1,] = c(2026,1)
cast[nrow(cast) + 1,] = c(2026,4)
cast[nrow(cast) + 1,] = c(2026,7)
cast[nrow(cast) + 1,] = c(2026,10)
cast[nrow(cast) + 1,] = c(2027,1)
cast[nrow(cast) + 1,] = c(2027,4)
cast[nrow(cast) + 1,] = c(2027,7)
cast[nrow(cast) + 1,] = c(2027,10)
cast[nrow(cast) + 1,] = c(2028,1)
cast[nrow(cast) + 1,] = c(2028,4)
cast[nrow(cast) + 1,] = c(2028,7)
cast[nrow(cast) + 1,] = c(2028,10)
cast[nrow(cast) + 1,] = c(2029,1)
cast[nrow(cast) + 1,] = c(2029,4)
cast[nrow(cast) + 1,] = c(2029,7)
cast[nrow(cast) + 1,] = c(2029,10)
cast[nrow(cast) + 1,] = c(2030,1)
cast[nrow(cast) + 1,] = c(2030,4)
cast[nrow(cast) + 1,] = c(2030,7)
cast[nrow(cast) + 1,] = c(2030,10)
cast[nrow(cast) + 1,] = c(2031,1)
cast[nrow(cast) + 1,] = c(2031,4)
cast[nrow(cast) + 1,] = c(2031,7)
cast[nrow(cast) + 1,] = c(2031,10)
cast[nrow(cast) + 1,] = c(2032,1)
cast[nrow(cast) + 1,] = c(2032,4)
cast[nrow(cast) + 1,] = c(2032,7)
cast[nrow(cast) + 1,] = c(2032,10)
cast[nrow(cast) + 1,] = c(2033,1)
cast[nrow(cast) + 1,] = c(2033,4)
cast[nrow(cast) + 1,] = c(2033,7)
cast[nrow(cast) + 1,] = c(2033,10)
cast[nrow(cast) + 1,] = c(2034,1)
cast[nrow(cast) + 1,] = c(2034,4)
cast[nrow(cast) + 1,] = c(2034,7)
cast[nrow(cast) + 1,] = c(2034,10)
cast[nrow(cast) + 1,] = c(2035,1)
cast[nrow(cast) + 1,] = c(2035,4)
cast[nrow(cast) + 1,] = c(2035,7)
cast[nrow(cast) + 1,] = c(2035,10)
cast[nrow(cast) + 1,] = c(2036,1)
cast[nrow(cast) + 1,] = c(2036,4)
cast[nrow(cast) + 1,] = c(2036,7)
cast[nrow(cast) + 1,] = c(2036,10)
cast[nrow(cast) + 1,] = c(2037,1)
cast[nrow(cast) + 1,] = c(2037,4)
cast[nrow(cast) + 1,] = c(2037,7)
cast[nrow(cast) + 1,] = c(2037,10)
cast[nrow(cast) + 1,] = c(2038,1)
cast[nrow(cast) + 1,] = c(2038,4)
cast[nrow(cast) + 1,] = c(2038,7)
cast[nrow(cast) + 1,] = c(2038,10)
cast[nrow(cast) + 1,] = c(2039,1)
cast[nrow(cast) + 1,] = c(2039,4)
cast[nrow(cast) + 1,] = c(2039,7)
cast[nrow(cast) + 1,] = c(2039,10)
cast[nrow(cast) + 1,] = c(2040,1)
cast[nrow(cast) + 1,] = c(2040,4)
cast[nrow(cast) + 1,] = c(2040,7)
cast[nrow(cast) + 1,] = c(2040,10)
cast[nrow(cast) + 1,] = c(2041,1)
cast[nrow(cast) + 1,] = c(2041,4)
cast[nrow(cast) + 1,] = c(2041,7)
cast[nrow(cast) + 1,] = c(2041,10)
cast[nrow(cast) + 1,] = c(2042,1)
cast[nrow(cast) + 1,] = c(2042,4)
cast[nrow(cast) + 1,] = c(2042,7)
cast[nrow(cast) + 1,] = c(2042,10)
cast[nrow(cast) + 1,] = c(2043,1)
cast[nrow(cast) + 1,] = c(2043,4)
cast[nrow(cast) + 1,] = c(2043,7)
cast[nrow(cast) + 1,] = c(2043,10)
cast[nrow(cast) + 1,] = c(2044,1)
cast[nrow(cast) + 1,] = c(2044,4)
cast[nrow(cast) + 1,] = c(2044,7)
cast[nrow(cast) + 1,] = c(2044,10)
cast[nrow(cast) + 1,] = c(2045,1)
cast[nrow(cast) + 1,] = c(2045,4)
cast[nrow(cast) + 1,] = c(2045,7)
cast[nrow(cast) + 1,] = c(2045,10)
cast[nrow(cast) + 1,] = c(2046,1)
cast[nrow(cast) + 1,] = c(2046,4)
cast[nrow(cast) + 1,] = c(2046,7)
cast[nrow(cast) + 1,] = c(2046,10)
cast[nrow(cast) + 1,] = c(2047,1)
cast[nrow(cast) + 1,] = c(2047,4)
cast[nrow(cast) + 1,] = c(2047,7)
cast[nrow(cast) + 1,] = c(2047,10)
cast[nrow(cast) + 1,] = c(2048,1)
cast[nrow(cast) + 1,] = c(2048,4)
cast[nrow(cast) + 1,] = c(2048,7)
cast[nrow(cast) + 1,] = c(2048,10)
cast[nrow(cast) + 1,] = c(2049,1)
cast[nrow(cast) + 1,] = c(2049,4)
cast[nrow(cast) + 1,] = c(2049,7)
cast[nrow(cast) + 1,] = c(2049,10)
cast[nrow(cast) + 1,] = c(2050,1)
cast[nrow(cast) + 1,] = c(2050,4)
cast[nrow(cast) + 1,] = c(2050,7)
cast[nrow(cast) + 1,] = c(2050,10)
cast[nrow(cast) + 1,] = c(2051,1)
cast[nrow(cast) + 1,] = c(2051,4)
cast[nrow(cast) + 1,] = c(2051,7)
cast[nrow(cast) + 1,] = c(2051,10)
cast[nrow(cast) + 1,] = c(2052,1)
cast[nrow(cast) + 1,] = c(2052,4)
cast[nrow(cast) + 1,] = c(2052,7)
cast[nrow(cast) + 1,] = c(2052,10)
cast[nrow(cast) + 1,] = c(2053,1)
cast[nrow(cast) + 1,] = c(2053,4)
cast[nrow(cast) + 1,] = c(2053,7)
cast[nrow(cast) + 1,] = c(2053,10)
cast[nrow(cast) + 1,] = c(2054,1)
cast[nrow(cast) + 1,] = c(2054,4)
cast[nrow(cast) + 1,] = c(2054,7)
cast[nrow(cast) + 1,] = c(2054,10)
cast[nrow(cast) + 1,] = c(2055,1)
cast[nrow(cast) + 1,] = c(2055,4)
cast[nrow(cast) + 1,] = c(2055,7)
cast[nrow(cast) + 1,] = c(2055,10)
cast[nrow(cast) + 1,] = c(2056,1)
cast[nrow(cast) + 1,] = c(2056,4)
cast[nrow(cast) + 1,] = c(2056,7)
cast[nrow(cast) + 1,] = c(2056,10)
cast[nrow(cast) + 1,] = c(2057,1)
cast[nrow(cast) + 1,] = c(2057,4)
cast[nrow(cast) + 1,] = c(2057,7)
cast[nrow(cast) + 1,] = c(2057,10)
cast[nrow(cast) + 1,] = c(2058,1)
cast[nrow(cast) + 1,] = c(2058,4)
cast[nrow(cast) + 1,] = c(2058,7)
cast[nrow(cast) + 1,] = c(2058,10)
cast[nrow(cast) + 1,] = c(2059,1)
cast[nrow(cast) + 1,] = c(2059,4)
cast[nrow(cast) + 1,] = c(2059,7)
cast[nrow(cast) + 1,] = c(2059,10)
cast[nrow(cast) + 1,] = c(2060,1)
cast[nrow(cast) + 1,] = c(2060,4)
cast[nrow(cast) + 1,] = c(2060,7)
cast[nrow(cast) + 1,] = c(2060,10)
cast[nrow(cast) + 1,] = c(2061,1)
cast[nrow(cast) + 1,] = c(2061,4)
cast[nrow(cast) + 1,] = c(2061,7)
cast[nrow(cast) + 1,] = c(2061,10)
cast[nrow(cast) + 1,] = c(2062,1)
cast[nrow(cast) + 1,] = c(2062,4)
cast[nrow(cast) + 1,] = c(2062,7)
cast[nrow(cast) + 1,] = c(2062,10)
cast[nrow(cast) + 1,] = c(2063,1)
cast[nrow(cast) + 1,] = c(2063,4)
cast[nrow(cast) + 1,] = c(2063,7)
cast[nrow(cast) + 1,] = c(2063,10)
cast[nrow(cast) + 1,] = c(2064,1)
cast[nrow(cast) + 1,] = c(2064,4)
cast[nrow(cast) + 1,] = c(2064,7)
cast[nrow(cast) + 1,] = c(2064,10)
cast[nrow(cast) + 1,] = c(2065,1)
cast[nrow(cast) + 1,] = c(2065,4)
cast[nrow(cast) + 1,] = c(2065,7)
cast[nrow(cast) + 1,] = c(2065,10)
cast[nrow(cast) + 1,] = c(2066,1)
cast[nrow(cast) + 1,] = c(2066,4)
cast[nrow(cast) + 1,] = c(2066,7)
cast[nrow(cast) + 1,] = c(2066,10)
cast[nrow(cast) + 1,] = c(2067,1)
cast[nrow(cast) + 1,] = c(2067,4)
cast[nrow(cast) + 1,] = c(2067,7)
cast[nrow(cast) + 1,] = c(2067,10)
cast[nrow(cast) + 1,] = c(2068,1)
cast[nrow(cast) + 1,] = c(2068,4)
cast[nrow(cast) + 1,] = c(2068,7)
cast[nrow(cast) + 1,] = c(2068,10)
cast[nrow(cast) + 1,] = c(2069,1)
cast[nrow(cast) + 1,] = c(2069,4)
cast[nrow(cast) + 1,] = c(2069,7)
cast[nrow(cast) + 1,] = c(2069,10)
cast[nrow(cast) + 1,] = c(2070,1)
cast[nrow(cast) + 1,] = c(2070,4)
cast[nrow(cast) + 1,] = c(2070,7)
cast[nrow(cast) + 1,] = c(2070,10)
cast[nrow(cast) + 1,] = c(2071,1)
cast[nrow(cast) + 1,] = c(2071,4)
cast[nrow(cast) + 1,] = c(2071,7)
cast[nrow(cast) + 1,] = c(2071,10)
cast[nrow(cast) + 1,] = c(2072,1)
cast[nrow(cast) + 1,] = c(2072,4)
cast[nrow(cast) + 1,] = c(2072,7)
cast[nrow(cast) + 1,] = c(2072,10)
cast[nrow(cast) + 1,] = c(2073,1)
cast[nrow(cast) + 1,] = c(2073,4)
cast[nrow(cast) + 1,] = c(2073,7)
cast[nrow(cast) + 1,] = c(2073,10)

# plot predictions against time index
SVRcast <- predict(tunedModel, cast)
autoplot(ts(SVRcast))

SVRcast <- as.data.frame(SVRcast)
results <- cbind(cast, SVRcast)
